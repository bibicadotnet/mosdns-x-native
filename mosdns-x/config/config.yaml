# =============================================================================
# Mosdns-x PR (Privacy & Resilience) Configuration for dns.bibica.net
# Architecture: Clean DNS, ECS CDN, Domain Routing with Memory Cache
# =============================================================================

# ============================================================================
# LOGGING
# ============================================================================
log:
  level: error	# Options: debug, info, error, warn
  file: "log/mosdns.log"

# ============================================================================
# DATA PROVIDERS - External domain lists and rules
# ============================================================================
data_providers:
  # TLD validation
  - tag: provider_valid_tlds
    file: "rules/valid_tlds.txt"
    auto_reload: true

  - tag: domain_list_private_tlds
    file: "rules/private_tlds.txt"
    auto_reload: true

  # Domain routing lists
  - tag: cdn_domains
    file: "rules/cdn_domains.txt"
    auto_reload: true

  - tag: google_domains
    file: "rules/google_upstream.txt"
    auto_reload: true

  - tag: mullvad_domains
    file: "rules/mullvad_upstream.txt"
    auto_reload: true

  # CDN IP ranges
  - tag: cloudfront_ips
    file: "rules/cloudfront_ips.txt"
    auto_reload: true

  - tag: fastly_ips
    file: "rules/fastly_ips.txt"
    auto_reload: true

  - tag: bunnycdn_ips
    file: "rules/bunnycdn_ips.txt"
    auto_reload: true

  - tag: gcore_ips
    file: "rules/gcore_ips.txt"
    auto_reload: true

  # Content filtering
  - tag: allowlist_domains
    file: "rules/allowlists.txt"
    auto_reload: true

  - tag: blocklist_domains
    file: "rules/blocklists.txt"
    auto_reload: true

  # DNS rewrite rules
  - tag: redirect_rules
    file: "rules/redirect_rules.txt"
    auto_reload: true

# ============================================================================
# PLUGINS
# ============================================================================
plugins:
  # ==========================================================================
  # QUERY MATCHERS - Identify query types and sources
  # ==========================================================================
  
  # Query type matchers
  - tag: query_is_ptr
    type: query_matcher
    args:
      qtype: [12] # PTR (reverse DNS)

  - tag: query_is_ipv6
    type: query_matcher
    args:
      qtype: [28] # AAAA (IPv6)

  - tag: query_is_https
    type: query_matcher
    args:
      qtype: [65] # HTTPS record

  # Client source matcher
  - tag: query_matcher_localhost
    type: query_matcher
    args:
      client_ip:
        - "127.0.0.0/8"

  # Domain validation – prevent common human typing errors
  - tag: match_invalid_domain_format
    type: query_matcher
    args:
      domain:
        - 'regexp:[^a-zA-Z0-9._-]'   # Common typos / special characters (e.g. !, @, #, spaces)
        - 'regexp:^[^.]+$'           # Missing dot / TLD (e.g. "google" instead of "google.com")

  # Domain validation - Valid TLD check
  - tag: match_valid_tld
    type: query_matcher
    args:
      domain:
        - "provider:provider_valid_tlds"

  # Private TLD matcher (RFC 6761)
  - tag: match_domain_private_tld
    type: query_matcher
    args:
      domain:
        - "provider:domain_list_private_tlds"

  # Domain routing matchers
  - tag: match_cdn_domain
    type: query_matcher
    args:
      domain:
        - "provider:cdn_domains"

  - tag: match_google_domain
    type: query_matcher
    args:
      domain:
        - "provider:google_domains"

  - tag: match_mullvad_domain
    type: query_matcher
    args:
      domain:
        - "provider:mullvad_domains"

  # Content filtering matchers
  - tag: match_allowlisted
    type: query_matcher
    args:
      domain:
        - "provider:allowlist_domains"

  - tag: match_blocklisted
    type: query_matcher
    args:
      domain:
        - "provider:blocklist_domains"

  # ==========================================================================
  # RESPONSE MATCHERS - Analyze DNS responses
  # ==========================================================================
  
  - tag: response_has_cdn_cname
    type: response_matcher
    args:
      cname:
        - "provider:cdn_domains"

  - tag: response_has_cloudfront_ip
    type: response_matcher
    args:
      ip:
        - "provider:cloudfront_ips"

  - tag: response_has_fastly_ip
    type: response_matcher
    args:
      ip:
        - "provider:fastly_ips"

  - tag: response_has_bunnycdn_ip
    type: response_matcher
    args:
      ip:
        - "provider:bunnycdn_ips"

  - tag: response_has_gcore_ip
    type: response_matcher
    args:
      ip:
        - "provider:gcore_ips"

  - tag: response_server_failed
    type: response_matcher
    args:
      rcode: [2] # SERVFAIL

  # ==========================================================================
  # RESPONSE MODIFIERS
  # ==========================================================================
  
  - tag: response_max_2_ips
    type: limit_ip
    args:
      limit: 2

  - tag: ttl_short
    type: ttl
    args:
      minimal_ttl: 60
      maximum_ttl: 300

  # Ad-blocking blackhole (NULL IP response)
  - tag: black_hole
    type: blackhole
    args:
      rcode: 0
      ipv4: ["0.0.0.0"]

  # ==========================================================================
  # ECS & DNS PROCESSING
  # ==========================================================================
  
  - tag: ecs_handler
    type: ecs
    args:
      auto: true
      force_overwrite: true

  - tag: dns_redirect
    type: redirect
    args:
      rule:
        - "provider:redirect_rules"

  # ==========================================================================
  # MEMORY CACHE - Per-upstream caching strategy
  # ==========================================================================
  
  # Google cache (with ECS support)
  - tag: google_cache
    type: cache
    args:
      size: 424550 # google_cache
      compress_resp: false
      cache_everything: true
      lazy_cache_ttl: 259200
      lazy_cache_reply_ttl: 5

  # CDN direct cache (with ECS support)
  - tag: cdn_direct_cache
    type: cache
    args:
      size: 283034 # cdn_direct_cache
      compress_resp: false
      cache_everything: true
      lazy_cache_ttl: 259200
      lazy_cache_reply_ttl: 5

  # CDN CNAME cache (with ECS support)
  - tag: cdn_cname_cache
    type: cache
    args:
      size: 283034 # cdn_cname_cache
      compress_resp: false
      cache_everything: true
      lazy_cache_ttl: 259200
      lazy_cache_reply_ttl: 5

  # Mullvad cache (no ECS)
  - tag: mullvad_cache
    type: cache
    args:
      size: 1024 # mullvad_cache
      compress_resp: false
      cache_everything: false
      lazy_cache_ttl: 259200
      lazy_cache_reply_ttl: 5

  # Cloudflare cache (no ECS)
  - tag: cloudflare_cache
    type: cache
    args:
      size: 849101 # cloudflare_cache
      compress_resp: false
      cache_everything: false
      lazy_cache_ttl: 259200
      lazy_cache_reply_ttl: 5

  # ==========================================================================
  # UPSTREAM RESOLVERS
  # ==========================================================================
  
  - tag: upstream_google
    type: fast_forward
    args:
      upstream:
        - addr: "tls://8.8.8.8"
          dial_addr: "8.8.8.8"
        - addr: "https://8.8.4.4/dns-query"
          dial_addr: "8.8.4.4"

  - tag: upstream_cloudflare
    type: fast_forward
    args:
      upstream:
        - addr: "tls://1.1.1.1"
          dial_addr: "1.1.1.1"
        - addr: "https://1.0.0.1/dns-query"
          dial_addr: "1.0.0.1"

  - tag: upstream_cloudflare_gateway
    type: fast_forward
    args:
      upstream:
        - addr: "tls://bu0eg1tdzu.cloudflare-gateway.com"
          dial_addr: "162.159.36.5"
        - addr: "https://rhpcv957tj.cloudflare-gateway.com/dns-query"
          dial_addr: "162.159.36.20"

  - tag: upstream_mullvad
    type: fast_forward
    args:
      upstream:
        - addr: "tls://dns.mullvad.net"
          dial_addr: "194.242.2.2"
        - addr: "https://dns.mullvad.net/dns-query"
          dial_addr: "194.242.2.2"

  # ==========================================================================
  # MAIN SEQUENCE - DNS Query Processing Pipeline
  # ==========================================================================
  
  - tag: main
    type: sequence
    args:
      exec:
        # --------------------------------------------------------------------
        # PHASE 0: CACHE SHORTCUT (Fast Path)
        # --------------------------------------------------------------------
        # The lookup order is prioritized by cache size and traffic volume.
        # Short-circuits the pipeline if a record exists in memory.
        - cloudflare_cache
        - google_cache
        - cdn_direct_cache
        - cdn_cname_cache
        - mullvad_cache
        
        # ====================================================================
        # PHASE 1: Request Validation & Filtering
        # ====================================================================
        
        # Reject deprecated ANY queries (ANY 255)
        - _reject_any

        # Block IPv6 (28), PTR (12), and HTTPS (65) records
        - if: "query_is_ipv6 || query_is_ptr || query_is_https"
          exec:
            - _new_empty_response
            - _return

        # Block private TLDs (.local, .localhost, etc.)
        - if: match_domain_private_tld
          exec:
            - _new_nxdomain_response
            - _return

        # Reject malformed domains and invalid TLDs
        - if: "match_invalid_domain_format || !match_valid_tld"
          exec:
            - _new_nxdomain_response
            - _return

        # ====================================================================
        # PHASE 2: Query Preparation
        # ====================================================================
        
        # Remove client ECS
        - _no_ecs

        # Clean EDNS0 options
        - _edns0_filter_no_edns0

        # Apply performance optimizations
        - _misc_optm

        # Apply DNS rewrites (local overrides)
        - dns_redirect

        # ====================================================================
        # PHASE 3: Ad-Blocking
        # ====================================================================

        # Block ads/trackers (unless allowlisted)
        - if: "!match_allowlisted"
          exec:
            - if: match_blocklisted
              exec:
                - black_hole    # return NULL IP 0.0.0.0
                - _return

        # ====================================================================
        # PHASE 4: Query Logging & Routing
        # ====================================================================
        
        #- _query_summary

        # Route: Google domains → Google DNS (with conditional ECS)
        - if: match_google_domain
          exec:
            # Add ECS if not from localhost
            - if: "!query_matcher_localhost"
              exec:
                - ecs_handler
            - google_cache
            - upstream_google
            - if: response_server_failed
              exec:
                - upstream_google
                - if: response_server_failed
                  exec:
                    - _return
            - response_max_2_ips
            - ttl_short
            - _no_cname
            - _return

        # Route: CDN domains → Cloudflare Gateway (with ECS)
        - if: match_cdn_domain
          exec:
            - ecs_handler
            - cdn_direct_cache
            - upstream_cloudflare_gateway
            - if: response_server_failed
              exec:
                - upstream_cloudflare_gateway
                - if: response_server_failed
                  exec:
                    - _return
            - response_max_2_ips
            - ttl_short
            - _no_cname
            - _return

        # Route: Mullvad domains → Mullvad DNS
        - if: match_mullvad_domain
          exec:
            - mullvad_cache
            - upstream_mullvad
            - if: response_server_failed
              exec:
                - upstream_mullvad
                - if: response_server_failed
                  exec:
                    - _return
            - response_max_2_ips
            - ttl_short
            - _no_cname
            - _return

        # Route: Everything else → Cloudflare DNS (default)
        - cloudflare_cache
        - upstream_cloudflare
        - if: response_server_failed
          exec:
            - upstream_cloudflare
            - if: response_server_failed
              exec:
                - _return
        - response_max_2_ips
        - ttl_short
        - _no_cname

        # ====================================================================
        # PHASE 5: CDN Detection & Re-resolution
        # ====================================================================

        # Re-resolve if response has CDN CNAME OR any CDN IP (CloudFront/Fastly/BunnyCDN/Gcore)
        - if: "response_has_cdn_cname || response_has_cloudfront_ip || response_has_fastly_ip || response_has_bunnycdn_ip || response_has_gcore_ip"
          exec:
            - ecs_handler
            - cdn_cname_cache
            - upstream_cloudflare_gateway
            - if: response_server_failed
              exec:
                - upstream_cloudflare_gateway
                - if: response_server_failed
                  exec:
                    - _return
            - response_max_2_ips
            - ttl_short
            - _no_cname
            - _return

# ============================================================================
# SERVERS - Protocol Listeners
# ============================================================================
servers:
  - exec: main
    listeners:
      # DNS-over-UDP
      - protocol: udp
        addr: "0.0.0.0:53"

      # DNS-over-TCP
      - protocol: tcp
        addr: "0.0.0.0:53"

      # DNS-over-HTTPS (DoH)
      - protocol: https
        addr: "0.0.0.0:443"
        url_path: "/dns-query"
        health_path: "/health"
        redirect_url: "https://bibica.net/dns-mien-phi-tu-dns-bibica-net/"
        cert: "/home/lego/certificates/dns.bibica.net.crt"
        key: "/home/lego/certificates/dns.bibica.net.key"
        allowed_sni: "dns.bibica.net"

      # DNS-over-HTTP/3 (DoH3)
      - protocol: h3
        addr: "0.0.0.0:443"
        url_path: "/dns-query"
        health_path: "/health"
        redirect_url: "https://bibica.net/dns-mien-phi-tu-dns-bibica-net/"
        cert: "/home/lego/certificates/dns.bibica.net.crt"
        key: "/home/lego/certificates/dns.bibica.net.key"
        allowed_sni: "dns.bibica.net"

      # DNS-over-TLS (DoT)
      - protocol: tls
        addr: "0.0.0.0:853"
        cert: "/home/lego/certificates/dns.bibica.net.crt"
        key: "/home/lego/certificates/dns.bibica.net.key"
        allowed_sni: "dns.bibica.net"

      # DNS-over-QUIC (DoQ)
      - protocol: quic
        addr: "0.0.0.0:853"
        cert: "/home/lego/certificates/dns.bibica.net.crt"
        key: "/home/lego/certificates/dns.bibica.net.key"
        allowed_sni: "dns.bibica.net"
