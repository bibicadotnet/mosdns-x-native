# =============================================================================
# MosDNS-X Configuration for dns.bibica.net
# Architecture: Clean DNS, ECS CDN, Domain Routing with Memory Cache
# =============================================================================

# ============================================================================
# LOGGING CONFIGURATION - System Events & Error Tracking
# ============================================================================
log:
  level: error # Options: debug, info, error, warn
  file: "log/mosdns.log"

# ============================================================================
# DATA PROVIDERS - External Rule Sets & Domain Lists
# ============================================================================
data_providers:
  - tag: cdn_domains
    file: "rules/cdn_domains.txt"
    auto_reload: true
  
  - tag: google_domains
    file: "rules/google_upstream.txt"
    auto_reload: true
  
  - tag: mullvad_domains
    file: "rules/mullvad_upstream.txt"
    auto_reload: true
  
  - tag: allowlist_domains
    file: "rules/allowlists.txt"
    auto_reload: true
  
  - tag: blocklist_domains
    file: "rules/blocklists.txt"
    auto_reload: true
  
  - tag: redirect_rules
    file: "rules/redirect_rules.txt"
    auto_reload: true
    
  - tag: domain_list_private_tlds
    file: "rules/private_tlds.txt"
    auto_reload: true

# ============================================================================
# PLUGINS CONFIGURATION - Functional Modules & Matchers
# ============================================================================
plugins:
  # ----- Query Matchers -----
  # Matcher for localhost clients
  - tag: query_matcher_localhost
    type: query_matcher
    args:
      client_ip:
        - "127.0.0.0/8"

  # ----- Query Type Matchers -----
  - tag: query_is_ptr
    type: query_matcher
    args:
      qtype: [12] # PTR record

  - tag: query_is_ipv6
    type: query_matcher
    args:
      qtype: [28] # AAAA record

  # ----- ECS Handler -----
  - tag: ecs_handler
    type: ecs
    args:
      auto: true
      force_overwrite: true

  # ----- TTL Override -----
  - tag: ttl_short
    type: ttl
    args:
      minimal_ttl: 1
      maximum_ttl: 1

  # ----- Domain Matchers -----
  - tag: match_cdn_domain
    type: query_matcher
    args:
      domain: ["provider:cdn_domains"]
  - tag: match_google_domain
    type: query_matcher
    args:
      domain: ["provider:google_domains"]
  - tag: match_mullvad_domain
    type: query_matcher
    args:
      domain: ["provider:mullvad_domains"]
  - tag: match_allowlisted
    type: query_matcher
    args:
      domain: ["provider:allowlist_domains"]
  - tag: match_blocklisted
    type: query_matcher
    args:
      domain: ["provider:blocklist_domains"]
  - tag: match_domain_private_tld
    type: query_matcher
    args:
      domain: ["provider:domain_list_private_tlds"]

  # ----- Response Matchers -----
  - tag: response_has_cdn_cname
    type: response_matcher
    args:
      cname: ["provider:cdn_domains"]

  # ----- Memory Cache -----
  # Cache for Google domains (with ECS)
  - tag: google_cache
    type: cache
    args:
      size: 131072
      compress_resp: true
      cache_everything: true
      lazy_cache_ttl: 86400
      lazy_cache_reply_ttl: 5

  # Cache for CDN direct queries (with ECS)
  - tag: cdn_direct_cache
    type: cache
    args:
      size: 131072
      compress_resp: true
      cache_everything: true
      lazy_cache_ttl: 86400
      lazy_cache_reply_ttl: 5

  # Cache for CDN CNAME responses (with ECS)
  - tag: cdn_cname_cache
    type: cache
    args:
      size: 131072
      compress_resp: true
      cache_everything: true
      lazy_cache_ttl: 86400
      lazy_cache_reply_ttl: 5

  # Cache for Mullvad upstream (no ECS)
  - tag: mullvad_cache
    type: cache
    args:
      size: 1024
      compress_resp: true
      cache_everything: false
      lazy_cache_ttl: 86400
      lazy_cache_reply_ttl: 5

  # Cache for Cloudflare upstream (no ECS)
  - tag: cloudflare_cache
    type: cache
    args:
      size: 131072
      compress_resp: true
      cache_everything: false
      lazy_cache_ttl: 86400
      lazy_cache_reply_ttl: 5

  # ----- DNS Redirect/Rewrite -----
  - tag: dns_redirect
    type: redirect
    args:
      rule: ["provider:redirect_rules"]

  # ----- Upstream Resolvers -----
  - tag: upstream_cloudflare_gateway
    type: fast_forward
    args:
      upstream:
        - addr: "https://bu0eg1tdzu.cloudflare-gateway.com/dns-query"
  
  - tag: upstream_google
    type: fast_forward
    args:
      upstream:
        - addr: "https://8.8.8.8/dns-query"
  
  - tag: upstream_mullvad
    type: fast_forward
    args:
      upstream:
        - addr: "https://dns.mullvad.net/dns-query"
  
  - tag: upstream_cloudflare
    type: fast_forward
    args:
      upstream:
        - addr: "https://1.1.1.1/dns-query"

# ============================================================================
# MAIN SEQUENCE - Primary Query Processing Pipeline
# ============================================================================
  - tag: main
    type: sequence
    args:
      exec:
        # ======================================================================
        # PHASE 1: Request Filtering
        # ======================================================================
        # --- Reject ANY Queries (RFC 8482) ---
        # ANY queries are deprecated and often used in DNS amplification attacks
        - _reject_any

        # --- Block IPv6 Queries (AAAA) ---
        # Prefer IPv4 by returning empty responses for IPv6 lookups
        - if: query_is_ipv6
          exec:
            - _new_empty_response
            - _return

        # --- Block PTR Queries ---
        # Return NOTIMP (Not Implemented) for reverse DNS lookups
        - if: query_is_ptr
          exec:
            - _new_notimp_response
            - _return

        # --- Block Private-Use Domains (RFC 6761) ---
        # Return NXDOMAIN for private TLDs and local-use names
        - if: match_domain_private_tld
          exec:
            - _new_nxdomain_response
            - _return
            
        # ======================================================================
        # PHASE 2: Query Sanitization & Optimization
        # ======================================================================

        # --- Remove Inbound ECS ---
        # Strip client-provided ECS to prepare for our own EDNS handling
        - _no_ecs

        # --- EDNS0 Filter ---
        # Cleanup EDNS0 options for standard compliant upstream queries
        - _edns0_filter_no_edns0

        # --- Performance Optimization ---
        # Apply internal optimizations for forwarding servers
        - _misc_optm

        # --- Domain Rewriting ---
        # Apply local redirect and rewrite rules
        - dns_redirect

        # ======================================================================
        # PHASE 3: Content Filtering (Ad-Blocking)
        # ======================================================================

        # --- Apply Domain Blocklist ---
        # Return NXDOMAIN if in blocklist, unless explicitly allowlisted
        - if: "match_blocklisted && !match_allowlisted"
          exec:
            - _new_nxdomain_response
            - _return

        # ======================================================================
        # PHASE 4: Local Cache & Upstream Routing
        # ======================================================================

        # --- Logging ---
        # Generate summary for non-blocked requests
        #- _query_summary

        # --- Route Google Domains ---
        # Forward to Google DNS with ECS support and TTL adjustment (not localhost)
        - if: "match_google_domain && !query_matcher_localhost"
          exec:
            - ecs_handler
            - google_cache
            - upstream_google
            - ttl_short
            - _return
        
        # Route Google Domains without ECS (localhost only)
        - if: match_google_domain
          exec:
            - google_cache
            - upstream_google
            - ttl_short
            - _return

        # --- Route CDN Domains ---
        # Forward to Cloudflare Gateway with ECS for optimal CDN edge selection
        - if: match_cdn_domain
          exec:
            - ecs_handler
            - cdn_direct_cache
            - upstream_cloudflare_gateway
            - ttl_short
            - _return

        # --- Route Mullvad Domains ---
        # Dedicated routing for Mullvad services
        - if: match_mullvad_domain
          exec:
            - mullvad_cache
            - upstream_mullvad
            - ttl_short
            - _return

        # --- Memory Cache Lookup ---
        # Check local cache before forwarding to upstreams
        - cloudflare_cache

        # --- Default Upstream ---
        # Use standard Cloudflare DNS for all other queries
        - upstream_cloudflare
        
        # --- TTL Override ---
        # Force short TTL for client-side caching control
        - ttl_short

        # ======================================================================
        # PHASE 5: Post-Processing (Recursive CNAME Resolution)
        # ======================================================================

        # --- Handle CDN CNAME Responses ---
        # If response contains a CDN-related CNAME, re-query via Cloudflare Gateway
        - if: response_has_cdn_cname
          exec:
            - ecs_handler
            - cdn_cname_cache
            - upstream_cloudflare_gateway
            - ttl_short
            - _return

# ============================================================================
# SERVER CONFIGURATION - Protocol Listeners
# ============================================================================
servers:
  - exec: main
    listeners:
      # --- DNS-over-UDP (Standard DNS) ---
      - protocol: udp
        addr: "0.0.0.0:53"
      
      # --- DNS-over-TCP (Standard DNS) ---
      - protocol: tcp
        addr: "0.0.0.0:53"
      
      # --- DNS-over-HTTPS (DoH) ---
      - protocol: https
        addr: "0.0.0.0:443"
        url_path: "/dns-query"
        cert: "/home/lego/certificates/dns.bibica.net.crt"
        key: "/home/lego/certificates/dns.bibica.net.key"
      
      # --- DNS-over-HTTP/3 (DoH3) ---
      - protocol: h3
        addr: "0.0.0.0:443"
        url_path: "/dns-query"
        cert: "/home/lego/certificates/dns.bibica.net.crt"
        key: "/home/lego/certificates/dns.bibica.net.key"
      
      # --- DNS-over-TLS (DoT) ---
      - protocol: tls
        addr: "0.0.0.0:853"
        cert: "/home/lego/certificates/dns.bibica.net.crt"
        key: "/home/lego/certificates/dns.bibica.net.key"

      # --- DNS-over-QUIC (DoQ) ---
      - protocol: quic
        addr: "0.0.0.0:853"
        cert: "/home/lego/certificates/dns.bibica.net.crt"
        key: "/home/lego/certificates/dns.bibica.net.key"
